
[{"id":"34e48eba8b18bf88","type":"tab","label":"Slave - Dead Board","disabled":true,"info":"","env":[]},{"id":"57e87e2a06fa59f4","type":"mqtt in","z":"34e48eba8b18bf88","name":"LWT from Board","topic":"resp/esp32/5/1/+/3/0/4","qos":"2","datatype":"json","broker":"54d52f8897b8d24f","nl":false,"rap":true,"rh":0,"inputs":0,"x":180,"y":260,"wires":[["895fe812646464e6","98f58deffd36f5ba"]]},{"id":"895fe812646464e6","type":"function","z":"34e48eba8b18bf88","name":"Split and GET conditioner","func":"let topicParts = msg.topic.split('/');\nlet floor = topicParts[2];\nlet apartment = topicParts[3];\nlet devID = topicParts[4];\n\nlet status = msg.payload.v;\n\n\nlet query = {\n    topic: \"SELECT * FROM smartAirConditioner AS sac \"+\n            \"JOIN apartment AS ap \"+\n            \"ON sac.apartmentID = ap.apartmentID \"+\n            \"WHERE ap.apartment_number = \"+apartment+\" \"+\n            \"AND ap.floor = \"+floor+\" \"+\n            \"AND sac.boardNumber = \"+devID\n}\n\nif(status === \"Online\"){\n    return [query, null]\n}\nelse {\n    return [null, query]\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":260,"wires":[["45136fac0eb111ed"],["e60e505123c367a3"]],"outputLabels":["ONLINE","OFFLINE"]},{"id":"e60e505123c367a3","type":"mysql","z":"34e48eba8b18bf88","mydb":"3d82484f23ccce80","name":"Query","x":590,"y":300,"wires":[["f1a8275a35836f33"]]},{"id":"45136fac0eb111ed","type":"mysql","z":"34e48eba8b18bf88","mydb":"3d82484f23ccce80","name":"Query","x":590,"y":220,"wires":[["45c55636e3d7e7f7"]]},{"id":"45c55636e3d7e7f7","type":"function","z":"34e48eba8b18bf88","name":"Set Online","func":"let conditionerID = msg.payload[0].ID;\n\nmsg.topic = \"UPDATE smartAirConditioner \"+\n            \"SET connected = connected^1 \"+\n            \"WHERE ID = \"+conditionerID+\" \"+\n            \"AND connected = 0\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":220,"wires":[["27cbfe435fa3acab"]]},{"id":"f1a8275a35836f33","type":"function","z":"34e48eba8b18bf88","name":"Set Offline","func":"let conditionerID = msg.payload[0].ID;\n\nmsg.topic = \"UPDATE smartAirConditioner \"+\n            \"SET connected = connected^1 \"+\n            \"WHERE ID = \"+conditionerID+\" \"+\n            \"AND connected = 1\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":300,"wires":[["8ba7a241e44e3717"]]},{"id":"27cbfe435fa3acab","type":"mysql","z":"34e48eba8b18bf88","mydb":"3d82484f23ccce80","name":"Query","x":910,"y":220,"wires":[[]]},{"id":"8ba7a241e44e3717","type":"mysql","z":"34e48eba8b18bf88","mydb":"3d82484f23ccce80","name":"Query","x":910,"y":300,"wires":[[]]},{"id":"98f58deffd36f5ba","type":"debug","z":"34e48eba8b18bf88","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":390,"y":160,"wires":[]},{"id":"54d52f8897b8d24f","type":"mqtt-broker","name":"HiveMQ","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"sessionExpiry":""},{"id":"3d82484f23ccce80","type":"MySQLdatabase","name":"Amazon MySQL","host":"db-iotsystems.cfbti5otvmx7.us-east-1.rds.amazonaws.com","port":"3306","db":"iot-sys","tz":"","charset":"UTF8"}]
